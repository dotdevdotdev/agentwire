# AgentWire STT - Faster-Whisper Speech-to-Text
# Supports GPU (CUDA) and CPU execution
# Multi-arch: linux/amd64, linux/arm64

ARG ARCH=amd64

# GPU variant (CUDA)
FROM nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04 AS gpu-base
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    python3.11 \
    python3.11-dev \
    python3-pip \
    ffmpeg \
    pkg-config \
    libavformat-dev \
    libavcodec-dev \
    libavdevice-dev \
    libavutil-dev \
    libavfilter-dev \
    libswscale-dev \
    libswresample-dev \
    && rm -rf /var/lib/apt/lists/*
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1
ENV WHISPER_DEVICE=cuda

# CPU variant (ARM64 or x86_64)
FROM python:3.11-slim AS cpu-base
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    ffmpeg \
    pkg-config \
    libavformat-dev \
    libavcodec-dev \
    libavdevice-dev \
    libavutil-dev \
    libavfilter-dev \
    libswscale-dev \
    libswresample-dev \
    && rm -rf /var/lib/apt/lists/*
ENV WHISPER_DEVICE=cpu

# Select base based on build arg
FROM ${ARCH}-base AS final

WORKDIR /app

# Upgrade pip
RUN python3 -m pip install --upgrade pip

# Install STT dependencies
# Use latest faster-whisper for better dependency compatibility
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0 \
    python-multipart==0.0.6 \
    faster-whisper

# Copy STT server script
COPY agentwire/stt/stt_server.py .

# Download default Whisper model at build time (optional, reduces cold start)
# Options: tiny, base, small, medium, large-v2, large-v3
ARG WHISPER_MODEL=base
ENV WHISPER_MODEL=${WHISPER_MODEL}
RUN python3 -c "from faster_whisper import WhisperModel; WhisperModel('${WHISPER_MODEL}', device='cpu')" || \
    echo "Warning: Model download failed, will retry at runtime"

# Expose port
EXPOSE 8100

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8100/health || exit 1

# Set environment
ENV PYTHONUNBUFFERED=1

# Run STT server
CMD ["python3", "stt_server.py"]
