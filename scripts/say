#!/bin/bash
# Smart TTS with portal routing
# Usage: say "Hello world"
#        say "[laugh] That's funny"
#        say "Message" voicename
#
# Session detection priority:
#   1. .agentwire.yml in current or parent directory (session: field)
#   2. Infer from directory path (~/projects/{session} or worktrees)
#   3. tmux session name
#
# Smart routing:
#   - If portal has browser connections for the session, sends to portal
#   - Otherwise, generates TTS locally and plays via afplay
#
# Default voice: dotdev

set -e

TEXT="$1"
CLI_VOICE="$2"  # Explicit CLI voice (may be empty)
OUTPUT="/tmp/say_output.wav"

# Get portal URL from global config
get_portal_url() {
    # Try config.yaml first
    if [ -f "$HOME/.agentwire/config.yaml" ]; then
        local url=$(grep -E "^\s*url:" "$HOME/.agentwire/config.yaml" 2>/dev/null | head -1 | sed 's/.*url:[[:space:]]*//' | tr -d '"'"'" || true)
        if [ -n "$url" ]; then
            echo "$url"
            return
        fi
    fi
    # Fallback to portal_url file
    if [ -f "$HOME/.agentwire/portal_url" ]; then
        cat "$HOME/.agentwire/portal_url" | tr -d '\n'
        return
    fi
    # Default
    echo "https://localhost:8765"
}
PORTAL_URL=$(get_portal_url)

if [ -z "$TEXT" ]; then
    echo "Usage: say \"Your message\" [voice]"
    echo "       say \"[laugh] That's funny\" dotdev"
    exit 1
fi

# Find .agentwire.yml in current or parent directories
find_agentwire_config() {
    local dir="$PWD"
    local home="$HOME"

    while [ "$dir" != "/" ] && [ "$dir" != "$home" ]; do
        if [ -f "$dir/.agentwire.yml" ]; then
            echo "$dir/.agentwire.yml"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    return 1
}

# Extract session name from .agentwire.yml
get_session_from_config() {
    local config_file="$1"
    if [ -f "$config_file" ]; then
        # Simple YAML parsing - look for "session: value"
        grep -E "^session:" "$config_file" 2>/dev/null | sed 's/^session:[[:space:]]*//' | tr -d '"'"'" || true
    fi
}

# Extract voice from .agentwire.yml
get_voice_from_config() {
    local config_file="$1"
    if [ -f "$config_file" ]; then
        # Simple YAML parsing - look for "voice: value"
        grep -E "^voice:" "$config_file" 2>/dev/null | sed 's/^voice:[[:space:]]*//' | tr -d '"'"'" || true
    fi
}

# Infer session name from directory path
# Convention: ~/projects/{session} or ~/projects/{session}-worktrees/{branch}
infer_session_from_path() {
    local cwd="$PWD"
    local projects_dir="$HOME/projects"

    # Check if we're under ~/projects
    if [[ "$cwd" == "$projects_dir"* ]]; then
        # Get path relative to projects dir
        local rel_path="${cwd#$projects_dir/}"

        # Check for worktree pattern: {project}-worktrees/{branch}
        if [[ "$rel_path" =~ ^([^/]+)-worktrees/([^/]+) ]]; then
            local project="${BASH_REMATCH[1]}"
            local branch="${BASH_REMATCH[2]}"
            echo "${project}/${branch}"
            return 0
        fi

        # Simple project: first directory component
        local project=$(echo "$rel_path" | cut -d'/' -f1)
        if [ -n "$project" ]; then
            echo "$project"
            return 0
        fi
    fi
    return 1
}

# Get current session name with multi-source detection
get_session() {
    # 1. .agentwire.yml config file
    local config_file=$(find_agentwire_config)
    if [ -n "$config_file" ]; then
        local session=$(get_session_from_config "$config_file")
        if [ -n "$session" ]; then
            echo "$session"
            return
        fi
    fi

    # 2. Infer from directory path
    local inferred=$(infer_session_from_path)
    if [ -n "$inferred" ]; then
        echo "$inferred"
        return
    fi

    # 3. tmux session name (fallback)
    if [ -n "$TMUX" ]; then
        tmux display-message -p '#S' 2>/dev/null
        return
    fi

    echo ""
}

# Check if portal has browser connections for a session
# Returns 0 if connected, 1 if not
check_portal_connections() {
    local session="$1"
    if [ -z "$session" ]; then
        return 1
    fi

    # Get hostname for machine-qualified session names
    local hostname=$(hostname -s 2>/dev/null || hostname | cut -d. -f1)

    # Try session variants: as-is, with hostname, with @local
    for try_session in "$session" "${session}@${hostname}" "${session}@local"; do
        local encoded_session=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$try_session', safe=''))")
        local result=$(curl -sk "$PORTAL_URL/api/sessions/$encoded_session/connections" 2>/dev/null)
        if echo "$result" | grep -q '"has_connections": true'; then
            echo "$try_session"
            return 0
        fi
    done
    return 1
}

# Send TTS to portal (plays on browser clients)
send_to_portal() {
    local session="$1"
    local text="$2"
    local encoded_session=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$session', safe=''))")
    local json=$(python3 -c "import json; print(json.dumps({'text': '''$text'''}))")

    curl -sk -X POST "$PORTAL_URL/api/say/$encoded_session" \
        -H "Content-Type: application/json" \
        -d "$json" > /dev/null 2>&1
}

# Generate and play TTS locally via portal's RunPod backend
# The portal plays the audio server-side and returns JSON status
play_local() {
    local text="$1"
    local voice="$2"
    local session="$3"

    # Use portal's local-tts endpoint (plays audio server-side)
    local encoded_session=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${session:-default}', safe=''))")
    local json=$(python3 -c "import json; print(json.dumps({'text': '''$text''', 'voice': '$voice'}))")

    # Send to portal - it plays audio and returns JSON status
    local result=$(curl -sk -X POST "$PORTAL_URL/api/local-tts/$encoded_session" \
        -H "Content-Type: application/json" \
        -d "$json")

    if echo "$result" | grep -q '"success": true'; then
        # Audio played on server
        :
    else
        echo "TTS Error: $result"
        exit 1
    fi
}

# Main logic - smart routing

# Resolve voice: CLI arg > .agentwire.yml > default
if [ -n "$CLI_VOICE" ]; then
    VOICE="$CLI_VOICE"
else
    CONFIG_FILE=$(find_agentwire_config)
    if [ -n "$CONFIG_FILE" ]; then
        VOICE=$(get_voice_from_config "$CONFIG_FILE")
    fi
fi
VOICE="${VOICE:-dotdev}"  # Fallback to default

SESSION=$(get_session)
CONNECTED_SESSION=$(check_portal_connections "$SESSION") && HAS_CONNECTIONS=true || HAS_CONNECTIONS=false

if [ "$HAS_CONNECTIONS" = true ]; then
    # Browser connected - send to portal for playback there
    send_to_portal "$CONNECTED_SESSION" "$TEXT"
else
    # No browser connected - play locally via portal's TTS backend
    play_local "$TEXT" "$VOICE" "$SESSION"
fi
