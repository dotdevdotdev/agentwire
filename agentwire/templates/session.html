{% extends 'base.html' %}
{% from 'components/device_selector.html' import device_selector, range_selector, mode_toggle %}

{% block title %}{{ session_name }} - AgentWire{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/session.css">
<link rel="stylesheet" href="/static/css/orb.css">
{% endblock %}

{% block content %}
    <div class="header">
        <div class="header-left">
            <a href="/" class="header-brand"><img src="/static/logo-green.jpeg" alt="" class="header-logo">AgentWire</a>
            <div>
                <h1>{{ session_name }}{% if config.machine %}<span style="color:var(--text-muted);font-weight:normal">@{{ config.machine }}</span>{% endif %}</h1>
                <div class="status" id="status">connecting...</div>
            </div>
        </div>
        <div class="header-center">
            <div class="mode-tabs">
                <button class="mode-tab active" id="ambientTab" onclick="switchToMode('ambient')">Ambient</button>
                <button class="mode-tab" id="monitorTab" onclick="switchToMode('monitor')">Monitor</button>
                <button class="mode-tab" id="terminalTab" onclick="switchToMode('terminal')" title="Full interactive terminal via xterm.js">Terminal</button>
            </div>
        </div>
        <div class="header-right">
            <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()" title="Settings">‚öô</button>
            <div class="settings-dropdown" id="settingsDropdown">
                {{ device_selector('micSelect', 'Microphone', onchange='updateMic()') }}
                {{ device_selector('speakerSelect', 'Speaker', onchange='updateSpeaker()') }}
                <div class="settings-group">
                    <label>TTS Voice</label>
                    <select id="voiceSelect" onchange="updateVoice()">
                        {% for voice in voices %}
                        <option value="{{ voice }}"{% if voice == current_voice %} selected{% endif %}>{{ voice }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    {# Monitor Mode - Output View #}
    {% include 'components/output_view.html' %}

    {# Ambient Mode #}
    <div class="ambient ambient-default" id="ambient">
        <div class="ai-bubble-container">
            <div class="ai-bubble" id="aiBubble"></div>
        </div>

        {% include 'components/orb.html' %}

        <div class="user-bubble-container">
            <div class="user-bubble" id="userBubble"></div>
        </div>
    </div>

    {# Terminal Mode #}
    <div class="mode-content terminal-mode-content" style="display: none;">
        <div class="terminal-activation" id="terminalActivation">
            <button class="activate-terminal-btn" id="activateTerminal">
                üñ•Ô∏è Activate Interactive Terminal
            </button>
            <p class="terminal-info">
                Connect to tmux session for full terminal control (vim, interactive commands, etc.)
            </p>
        </div>
        <div id="terminal" class="terminal-container" style="display: none;"></div>
        <div class="terminal-status" id="terminalStatus"></div>
    </div>

    {# Floating controls (both modes) #}
    <div class="floating-controls" id="floatingControls">
        <div class="text-input-wrapper">
            <button class="text-toggle-btn" id="textToggleBtn" onclick="toggleTextInput()">‚å®</button>
            <div class="text-input-expanded" id="textInputExpanded">
                <button class="attach-btn-ambient" id="attachBtnAmbient" onclick="triggerFileInput()" title="Attach image">üìé</button>
                <img class="ambient-image-preview" id="ambientImagePreview" src="" alt="">
                <textarea id="textInputAmbient" rows="1" placeholder="Type a message..." autocomplete="off"></textarea>
                <button class="send-btn" id="sendBtnAmbient" onclick="sendTextInputAmbient()">‚Üë</button>
            </div>
        </div>

        <div class="mic-area">
            {% include 'components/actions_menu.html' %}
            <button class="actions-btn" id="actionsBtn" onclick="toggleActionsMenu()">‚ãØ</button>
            <button class="mic-btn idle" id="micBtn">üé§</button>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)">

    {% include 'components/ask_modal.html' %}

    {# Permission Modal #}
    <div class="permission-modal" id="permissionModal">
        <div class="permission-card">
            <div class="permission-header">
                <span class="icon">üîí</span>
                <span class="badge">Permission Request</span>
            </div>
            <div class="permission-title" id="permissionTitle">Claude wants to...</div>
            <div class="permission-target" id="permissionTarget"></div>
            <div class="permission-diff" id="permissionDiff" style="display: none;">
                <pre id="permissionDiffContent"></pre>
            </div>
            <div class="permission-actions">
                <button class="permission-btn deny" onclick="respondToPermission('deny')">Deny</button>
                <button class="permission-btn allow-always" onclick="respondToPermission('allow_always')">Allow Always</button>
                <button class="permission-btn allow" onclick="respondToPermission('allow')">Allow</button>
            </div>
            <div class="permission-custom">
                <input type="text" id="permissionCustomInput" placeholder="Tell Claude what to do differently..." onkeydown="if(event.key==='Enter')respondToPermission('custom', this.value)">
                <button class="permission-btn custom" onclick="respondToPermission('custom', document.getElementById('permissionCustomInput').value)">Send</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    window.SESSION_CONFIG = {
        session: '{{ session_name }}',
        isSystemSession: {{ is_system_session_js }}
    };
</script>
<script type="module" src="/static/js/session.js"></script>
{% endblock %}
