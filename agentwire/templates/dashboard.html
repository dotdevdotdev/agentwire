{% extends 'base.html' %}

{% block title %}AgentWire{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
<div class="layout">
    <div class="header-row">
        <div class="brand">
            <img src="/static/agentwire-logo-splash-green-dark.png" alt="AgentWire" class="splash-logo">
            <div class="sound-notification-toggle">
                <label class="checkbox-toggle">
                    <input type="checkbox" id="soundNotificationEnabled">
                    <span class="toggle-label">ðŸ”” Sound on idle</span>
                </label>
            </div>
        </div>

        <div class="actions">
            <!-- Sessions Group -->
            <div class="action-group" id="sessionsGroup">
                <div class="action-header">
                    <span class="action-toggle">â–¼</span>
                    <h3>Sessions</h3>
                </div>
                <div class="action-content">
                    <div id="sessionCount" class="session-count"></div>

                    <!-- Archive Sub-action -->
                    <div class="sub-action" id="archiveGroup">
                        <div class="sub-action-header">
                            <span class="action-toggle">â–¼</span>
                            <span>Archive</span>
                        </div>
                        <div class="sub-action-content">
                            <div id="archiveList" class="archive-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Machines Group -->
            <div class="action-group" id="machinesGroup">
                <div class="action-header">
                    <span class="action-toggle">â–¼</span>
                    <h3>Machines</h3>
                </div>
                <div class="action-content">
                    <div id="machinesList" class="machines-list"></div>

                    <!-- Add Machine Sub-action -->
                    <div class="sub-action" id="addMachineGroup">
                        <div class="sub-action-header">
                            <span class="action-toggle">â–¼</span>
                            <span>Add Machine</span>
                        </div>
                        <div class="sub-action-content">
                            <div class="form-row">
                                <label>Machine ID</label>
                                <input type="text" id="machineId" placeholder="e.g., gpu-server">
                            </div>
                            <div class="form-row">
                                <label>Host</label>
                                <input type="text" id="machineHost" placeholder="e.g., 192.168.1.100">
                            </div>
                            <div class="form-row">
                                <label>User (optional)</label>
                                <input type="text" id="machineUser" placeholder="e.g., ubuntu">
                            </div>
                            <div class="form-row">
                                <label>Projects Dir (optional)</label>
                                <input type="text" id="machineProjectsDir" placeholder="e.g., ~/projects">
                            </div>
                            <button class="action-btn">Add</button>
                            <div class="error" id="machineError"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Group -->
            <div class="action-group" id="configGroup">
                <div class="action-header">
                    <span class="action-toggle">â–¼</span>
                    <h3>Config</h3>
                </div>
                <div class="action-content">
                    <div id="configPath" class="config-path"></div>
                    <textarea id="configEditor" class="config-editor" spellcheck="false"></textarea>
                    <div class="config-buttons">
                        <button class="action-btn">Save</button>
                        <button class="action-btn secondary">Save & Reload</button>
                        <button class="action-btn secondary" title="Fullscreen editor">â›¶</button>
                    </div>
                    <div class="success" id="configSuccess"></div>
                    <div class="error" id="configError"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="sessions-section">
        <div class="section-title">Active Sessions</div>
        <div class="sessions" id="sessions">
            <div class="no-sessions">Loading sessions...</div>
        </div>
    </div>
</div>

<!-- Create Session Modal -->
<div id="createSessionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create Session</h2>
            <span id="createSessionMachineName" class="machine-name"></span>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <label>Session Name</label>
                <div class="session-name-input">
                    <input type="text" id="sessionName" placeholder="e.g., assistant">
                    <span class="machine-suffix" id="machineSuffix"></span>
                </div>
            </div>
            <div class="form-row">
                <label>Project Path (optional)</label>
                <input type="text" id="projectPath" placeholder="~/projects/name">
            </div>
            <div class="form-row git-options" id="gitOptions" style="display: none;">
                <div class="git-status">
                    <span class="git-indicator"></span>
                    <span class="git-branch-label">on <span id="gitCurrentBranch" class="git-branch"></span></span>
                </div>
                <label class="checkbox-option">
                    <input type="checkbox" id="useWorktree" checked>
                    <span>Create worktree</span>
                </label>
                <div class="branch-row" id="branchRow">
                    <label>Branch Name</label>
                    <input type="text" id="branchName" placeholder="e.g., jan-3-work">
                </div>
            </div>
            <div class="form-row">
                <label>Template (optional)</label>
                <select id="sessionTemplate">
                    <option value="">None - Start fresh</option>
                    <!-- Populated from /api/templates -->
                </select>
                <div id="templatePreview" class="template-preview" style="display: none;">
                    <div class="template-description" id="templateDescription"></div>
                    <div class="template-prompt" id="templatePrompt"></div>
                </div>
            </div>
            <div class="form-row">
                <label>Voice</label>
                <select id="sessionVoice">
                    {% for voice in voices %}
                    <option value="{{ voice }}"{% if voice == default_voice %} selected{% endif %}>{{ voice }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-row">
                <label>Permission Mode</label>
                <div class="radio-group">
                    <label class="radio-option selected">
                        <input type="radio" name="permissionMode" value="bypass" checked>
                        <div class="radio-option-content">
                            <div class="radio-option-label">Bypass Permissions (Recommended)</div>
                            <div class="radio-option-desc">Claude auto-accepts all prompts for faster workflow</div>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="permissionMode" value="normal">
                        <div class="radio-option-content">
                            <div class="radio-option-label">Normal Session</div>
                            <div class="radio-option-desc">Permission prompts appear in portal for approval</div>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="permissionMode" value="restricted">
                        <div class="radio-option-content">
                            <div class="radio-option-label">Restricted Mode</div>
                            <div class="radio-option-desc">Only say commands allowed, all else denied</div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="error" id="error"></div>
        </div>
        <div class="modal-footer">
            <div class="modal-buttons">
                <button class="action-btn secondary">Cancel</button>
                <button class="action-btn">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Config Editor</h2>
            <span id="modalConfigPath" class="config-path"></span>
        </div>
        <textarea id="modalConfigEditor" class="modal-editor" spellcheck="false"></textarea>
        <div class="modal-footer">
            <div class="modal-messages">
                <div class="success" id="modalConfigSuccess"></div>
                <div class="error" id="modalConfigError"></div>
            </div>
            <div class="modal-buttons">
                <button class="action-btn secondary">Close</button>
                <button class="action-btn secondary">Save</button>
                <button class="action-btn">Save & Reload</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass server-side config to JS module
    window.AGENTWIRE_CONFIG = {
        defaultVoice: '{{ default_voice }}'
    };
</script>
<script type="module" src="/static/js/dashboard.js"></script>
{% endblock %}
